// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  // NOTE: When using mysql or sqlserver, uncomment the @db.Text annotations in model Account below
  // Further reading:
  // https://next-auth.js.org/adapters/prisma#create-the-prisma-schema
  // https://www.prisma.io/docs/reference/api-reference/prisma-schema-reference#string
  url      = env("DATABASE_URL")
}

// ============================================
// ZONITRACK+ GEO-INTELLIGENT SYSTEM MODELS
// ============================================

// Barangay (Administrative divisions)
model Barangay {
  id         String   @id @default(cuid())
  name       String   @unique
  code       String   @unique
  population Int?
  area       Float? // in square kilometers
  // GeoJSON polygon for barangay boundary
  boundary   Json?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  businesses  Business[]
  hazardZones HazardZone[]

  @@index([name])
}

// Zoning Classifications
model ZoneType {
  id          String   @id @default(cuid())
  code        String   @unique // e.g., "R1", "C1", "I1", "A1"
  name        String // e.g., "Residential Low Density", "Commercial"
  description String?
  color       String? // Hex color for map visualization
  rules       Json? // Zoning rules and restrictions
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  zones Zone[]

  @@index([code])
}

// Specific zones within barangays
model Zone {
  id           String   @id @default(cuid())
  name         String
  zoneTypeId   String
  zoneType     ZoneType @relation(fields: [zoneTypeId], references: [id])
  // GeoJSON polygon for zone boundary
  boundary     Json
  area         Float? // in square meters
  restrictions Json? // Specific restrictions for this zone
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  businesses Business[]

  @@index([zoneTypeId])
}

// Business Categories
model BusinessCategory {
  id           String   @id @default(cuid())
  name         String   @unique
  code         String   @unique
  description  String?
  // Allowed zone types for this category
  allowedZones Json? // Array of zone type codes
  minDistance  Float? // Minimum distance from similar businesses (meters)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  businesses Business[]

  @@index([code])
}

// Business Applications
model Business {
  id            String  @id @default(cuid())
  applicationNo String  @unique
  businessName  String
  ownerName     String
  ownerContact  String?
  ownerEmail    String?

  // Location data
  address    String
  barangayId String
  barangay   Barangay @relation(fields: [barangayId], references: [id])
  latitude   Float
  longitude  Float

  // Business details
  categoryId  String
  category    BusinessCategory @relation(fields: [categoryId], references: [id])
  description String?

  // Zoning compliance
  zoneId String?
  zone   Zone?   @relation(fields: [zoneId], references: [id])

  // Compliance status
  status           ApplicationStatus @default(PENDING)
  complianceChecks Json? // Results of automated checks
  riskFlags        Json? // Hazard and risk assessments

  // Approval workflow
  submittedAt    DateTime  @default(now())
  reviewedAt     DateTime?
  approvedAt     DateTime?
  reviewedBy     String?
  reviewedByUser User?     @relation(fields: [reviewedBy], references: [id])
  remarks        String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([barangayId])
  @@index([categoryId])
  @@index([status])
  @@index([latitude, longitude])
}

enum ApplicationStatus {
  PENDING
  UNDER_REVIEW
  APPROVED
  REJECTED
  REQUIRES_REVISION
}

// Hazard Zones (Flood, Landslide, etc.)
model HazardZone {
  id           String         @id @default(cuid())
  name         String
  type         HazardType
  severity     HazardSeverity
  barangayId   String?
  barangay     Barangay?      @relation(fields: [barangayId], references: [id])
  // GeoJSON polygon for hazard zone
  boundary     Json
  description  String?
  source       String? // Data source
  dateAssessed DateTime?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  @@index([type])
  @@index([severity])
  @@index([barangayId])
}

enum HazardType {
  FLOOD
  LANDSLIDE
  EARTHQUAKE_FAULT
  COASTAL_HAZARD
  FIRE_HAZARD
  OTHER
}

enum HazardSeverity {
  LOW
  MODERATE
  HIGH
  VERY_HIGH
}

// Proximity Rules (e.g., schools, churches, residential areas)
model ProximityRule {
  id          String   @id @default(cuid())
  name        String
  description String?
  // What business categories this applies to
  appliesTo   Json // Array of business category codes
  // What to check proximity against
  targetType  String // e.g., "SCHOOL", "CHURCH", "RESIDENTIAL"
  minDistance Float // Minimum required distance in meters
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([targetType])
}

// Points of Interest (Schools, Churches, etc.)
model PointOfInterest {
  id          String   @id @default(cuid())
  name        String
  type        String // e.g., "SCHOOL", "CHURCH", "HOSPITAL"
  address     String?
  latitude    Float
  longitude   Float
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([type])
  @@index([latitude, longitude])
}

// Analytics and Reports
model AnalyticsReport {
  id          String   @id @default(cuid())
  title       String
  type        String // e.g., "CLUSTERING", "DENSITY", "COMPLIANCE"
  data        Json // Report data and visualizations
  parameters  Json? // Parameters used to generate report
  generatedBy String
  user        User     @relation(fields: [generatedBy], references: [id])
  createdAt   DateTime @default(now())

  @@index([type])
  @@index([generatedBy])
}

// Zoning Application (COE - Certificate of Exception)
model ZoningApplication {
  id            String @id @default(cuid())
  applicationNo String @unique

  // Applicant Information
  applicantName    String
  applicantAddress String
  applicantContact String
  applicantEmail   String

  // Project Information
  projectDescription    String? @db.Text
  projectBoundaries     String? @db.Text
  projectObjectives     String? @db.Text
  zoningExceptionReason String? @db.Text

  // Representative Information
  isRepresentative   Boolean @default(false)
  representativeName String?

  // Proof of Lot Ownership Type
  lotOwnershipType LotOwnershipType?

  // Document URLs (stored file paths/URLs)
  // Required Documents
  taxClearanceOriginal  String?
  taxClearancePhotocopy String?

  // Proof of Lot Ownership (one of these based on lotOwnershipType)
  transferCertificateOfTitle String?
  leaseContract              String?
  awardNotice                String?
  deedOfSale                 String?
  memorandumOfAgreement      String?
  affidavitOfConsent         String?
  specialPowerOfAttorney     String?

  // Other Required Documents
  authorityToSign        String?
  lotPlan                String?
  architecturalPlan      String?
  professionalTaxReceipt String?
  longFolder             Boolean @default(false)

  // COE Mandatory Requirements
  projectDescriptionDoc       String?
  projectDescriptionPhotocopy String?

  // Representative Documents
  authorizationLetter String?
  representedPersonId String?
  representativeId    String?

  // Application Status
  status      ZoningApplicationStatus @default(SUBMITTED)
  submittedAt DateTime                @default(now())
  reviewedAt  DateTime?
  approvedAt  DateTime?
  rejectedAt  DateTime?

  // Reviewer
  reviewedBy     String?
  reviewedByUser User?   @relation(fields: [reviewedBy], references: [id])
  remarks        String? @db.Text

  // User who submitted
  userId String
  user   User   @relation("UserApplications", fields: [userId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([userId])
  @@index([applicationNo])
}

enum LotOwnershipType {
  TRANSFER_CERTIFICATE_OF_TITLE
  LEASE_CONTRACT
  AWARD_NOTICE
  DEED_OF_SALE
  MEMORANDUM_OF_AGREEMENT
  AFFIDAVIT_OF_CONSENT
  SPECIAL_POWER_OF_ATTORNEY
}

enum ZoningApplicationStatus {
  SUBMITTED
  REVIEWING
  REJECTED
  APPROVED
  FOR_EVALUATION
}

// ============================================
// AUTHENTICATION MODELS (Next Auth)
// ============================================

model Post {
  id        Int      @id @default(autoincrement())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  createdBy   User   @relation(fields: [createdById], references: [id])
  createdById String

  @@index([name])
}

model Account {
  id                       String  @id @default(cuid())
  userId                   String
  type                     String
  provider                 String
  providerAccountId        String
  refresh_token            String?
  access_token             String?
  expires_at               Int?
  token_type               String?
  scope                    String?
  id_token                 String?
  session_state            String?
  user                     User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  refresh_token_expires_in Int?

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  password      String? // For credentials-based authentication
  role          UserRole  @default(APPLICANT)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  accounts      Account[]
  sessions      Session[]
  posts         Post[]

  // ZoniTrack+ relations
  reviewedBusinesses Business[]
  reports            AnalyticsReport[]

  // Zoning Applications
  zoningApplications         ZoningApplication[] @relation("UserApplications")
  reviewedZoningApplications ZoningApplication[]
}

enum UserRole {
  ADMIN
  COMPLIANCE
  APPLICANT
  REVIEWER
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}
